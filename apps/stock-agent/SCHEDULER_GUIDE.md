# Stock Agent è‚¡ç¥¨æ•°æ®åˆ·æ–°è§¦å‘å™¨ä½¿ç”¨æŒ‡å—

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

Stock Agent ç°åœ¨æ”¯æŒè‚¡ç¥¨æ•°æ®çš„è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š

1. **å®šæ—¶å…¨å±€åˆ·æ–°**: æ¯å‘¨ä¸€åˆ°å‘¨äº”ä¸‹åˆ3ç‚¹è‡ªåŠ¨åˆ·æ–°æ‰€æœ‰è‚¡ç¥¨æ•°æ®
2. **å•åªè‚¡ç¥¨åˆ·æ–°**: æŒ‰éœ€åˆ·æ–°æŒ‡å®šè‚¡ç¥¨çš„æ•°æ®
3. **ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª**: ç›‘æ§åˆ·æ–°ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€å’Œç»“æœ

## âš™ï¸ é…ç½®è¯´æ˜

### è°ƒåº¦å™¨é…ç½®

è°ƒåº¦å™¨æ”¯æŒä»¥ä¸‹é…ç½®é€‰é¡¹ï¼š

```python
class SchedulerConfig:
    enabled: bool = True                              # æ˜¯å¦å¯ç”¨è°ƒåº¦å™¨
    global_refresh_time: str = "15:00"               # å…¨å±€åˆ·æ–°æ—¶é—´ (HH:MM)
    global_refresh_weekdays: List[int] = [1,2,3,4,5] # åˆ·æ–°å·¥ä½œæ—¥ (1=å‘¨ä¸€)
    timezone: str = "Asia/Shanghai"                   # æ—¶åŒº
    max_concurrent_tasks: int = 1                     # æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
```

### ç¯å¢ƒå˜é‡é…ç½®

å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è‡ªå®šä¹‰è°ƒåº¦å™¨è¡Œä¸ºï¼š

```bash
# å¯ç”¨/ç¦ç”¨è°ƒåº¦å™¨
SCHEDULER_ENABLED=true

# å…¨å±€åˆ·æ–°æ—¶é—´ (24å°æ—¶åˆ¶)
SCHEDULER_GLOBAL_REFRESH_TIME=15:00

# æ—¶åŒºè®¾ç½®
SCHEDULER_TIMEZONE=Asia/Shanghai
```

## ğŸš€ å¯åŠ¨æœåŠ¡

### 1. å®‰è£…ä¾èµ–

ç¡®ä¿å®‰è£…äº†è°ƒåº¦å™¨ç›¸å…³ä¾èµ–ï¼š

```bash
cd apps/stock-agent
pip install -r requirements.txt
```

### 2. å¯åŠ¨æœåŠ¡

```bash
python src/main.py
```

æœåŠ¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨ï¼š
- è¿æ¥æ•°æ®åº“
- å¯åŠ¨è‚¡ç¥¨åˆ·æ–°è°ƒåº¦å™¨
- å®‰æ’å®šæ—¶å…¨å±€åˆ·æ–°ä»»åŠ¡

## ğŸ“¡ API æ¥å£

### 1. åˆ·æ–°å•åªè‚¡ç¥¨æ•°æ®

```bash
# åˆ·æ–°æŒ‡å®šè‚¡ç¥¨æ•°æ®
POST /api/v1/stocks/refresh/single/{stock_code}

# ç¤ºä¾‹ï¼šåˆ·æ–°å¹³å®‰é“¶è¡Œæ•°æ®
curl -X POST "http://localhost:8020/api/v1/stocks/refresh/single/000001"
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "task_id": "single_refresh_000001_abc123",
    "stock_code": "000001",
    "status": "completed",
    "start_time": "2024-01-15T10:30:00",
    "result": {
      "total": 1,
      "success": 1,
      "failed": 0,
      "success_rate": 1.0
    }
  },
  "message": "è‚¡ç¥¨ 000001 åˆ·æ–°ä»»åŠ¡å·²å®Œæˆ"
}
```

### 2. è§¦å‘å…¨å±€åˆ·æ–°

```bash
# æ‰‹åŠ¨è§¦å‘å…¨å±€åˆ·æ–°
POST /api/v1/stocks/refresh/global

curl -X POST "http://localhost:8020/api/v1/stocks/refresh/global"
```

### 3. æŸ¥çœ‹åˆ·æ–°ä»»åŠ¡

```bash
# è·å–æœ€è¿‘çš„åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
GET /api/v1/stocks/refresh/tasks?limit=10

# è·å–æŒ‡å®šä»»åŠ¡çŠ¶æ€
GET /api/v1/stocks/refresh/tasks/{task_id}
```

### 4. è°ƒåº¦å™¨çŠ¶æ€

```bash
# è·å–è°ƒåº¦å™¨è¿è¡ŒçŠ¶æ€
GET /api/v1/stocks/scheduler/status

curl "http://localhost:8020/api/v1/stocks/scheduler/status"
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "running": true,
    "config": {
      "enabled": true,
      "global_refresh_time": "15:00",
      "global_refresh_weekdays": [1, 2, 3, 4, 5],
      "timezone": "Asia/Shanghai"
    },
    "running_tasks": 0,
    "next_global_refresh": "2024-01-16T15:00:00+08:00",
    "jobs": [
      {
        "id": "global_refresh",
        "name": "å…¨å±€è‚¡ç¥¨æ•°æ®åˆ·æ–°",
        "next_run_time": "2024-01-16T15:00:00+08:00"
      }
    ]
  },
  "message": "è°ƒåº¦å™¨çŠ¶æ€è·å–æˆåŠŸ"
}
```

## ğŸ§ª æµ‹è¯•åŠŸèƒ½

### è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
cd apps/stock-agent
python test_scheduler.py
```

æµ‹è¯•è„šæœ¬ä¼šéªŒè¯ï¼š
- è°ƒåº¦å™¨åŸºæœ¬åŠŸèƒ½
- è°ƒåº¦å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å•åªè‚¡ç¥¨åˆ·æ–°åŠŸèƒ½

### æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨æœåŠ¡**
   ```bash
   python src/main.py
   ```

2. **æ£€æŸ¥è°ƒåº¦å™¨çŠ¶æ€**
   ```bash
   curl "http://localhost:8020/api/v1/stocks/scheduler/status"
   ```

3. **æµ‹è¯•å•åªè‚¡ç¥¨åˆ·æ–°**
   ```bash
   curl -X POST "http://localhost:8020/api/v1/stocks/refresh/single/000001"
   ```

4. **æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨**
   ```bash
   curl "http://localhost:8020/api/v1/stocks/refresh/tasks"
   ```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—ä¿¡æ¯

è°ƒåº¦å™¨ä¼šè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼š

```
ğŸ“… è‚¡ç¥¨åˆ·æ–°è°ƒåº¦å™¨å¯åŠ¨æˆåŠŸ
ğŸ“… å·²å®‰æ’å…¨å±€åˆ·æ–°ä»»åŠ¡: æ¯å‘¨ [1, 2, 3, 4, 5] çš„ 15:00
ğŸ”„ å¼€å§‹æ‰§è¡Œå…¨å±€è‚¡ç¥¨æ•°æ®åˆ·æ–° - ä»»åŠ¡ID: global_refresh_abc123
ğŸ“Š å‡†å¤‡åˆ·æ–° 4000 åªè‚¡ç¥¨çš„æ•°æ®
âœ… å…¨å±€è‚¡ç¥¨æ•°æ®åˆ·æ–°å®Œæˆ - æˆåŠŸ: 3950/4000
```

### æ•°æ®åº“å­˜å‚¨

åˆ·æ–°ä»»åŠ¡ä¿¡æ¯ä¼šå­˜å‚¨åœ¨ MongoDB çš„ `tasks` é›†åˆä¸­ï¼š

```javascript
{
  "task_id": "single_refresh_000001_abc123",
  "task_type": "single_refresh",
  "stock_code": "000001",
  "status": "completed",
  "created_time": "2024-01-15T10:30:00Z",
  "start_time": "2024-01-15T10:30:01Z",
  "end_time": "2024-01-15T10:30:05Z",
  "duration": 4.2,
  "result": {
    "total": 1,
    "success": 1,
    "failed": 0,
    "success_rate": 1.0,
    "processed_codes": ["000001"],
    "failed_codes": []
  }
}
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è°ƒåº¦å™¨å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
   - ç¡®è®¤æ—¶åŒºè®¾ç½®æ˜¯å¦æ­£ç¡®
   - æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

2. **å®šæ—¶ä»»åŠ¡ä¸æ‰§è¡Œ**
   - ç¡®è®¤è°ƒåº¦å™¨é…ç½®ä¸­ `enabled=true`
   - æ£€æŸ¥æ—¶é—´å’Œå·¥ä½œæ—¥è®¾ç½®
   - æŸ¥çœ‹è°ƒåº¦å™¨çŠ¶æ€æ¥å£

3. **å•åªè‚¡ç¥¨åˆ·æ–°å¤±è´¥**
   - æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤ç½‘ç»œè¿æ¥å’Œæ•°æ®æºå¯ç”¨
   - æŸ¥çœ‹ä»»åŠ¡è¯¦ç»†é”™è¯¯ä¿¡æ¯

### è°ƒè¯•æ¨¡å¼

å¯åŠ¨æœåŠ¡æ—¶å¯ä»¥å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼š

```bash
STOCK_API_DEBUG=true python src/main.py
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **ç›‘æ§è°ƒåº¦å™¨çŠ¶æ€**
   - å®šæœŸæ£€æŸ¥è°ƒåº¦å™¨è¿è¡ŒçŠ¶æ€
   - ç›‘æ§ä»»åŠ¡æ‰§è¡ŒæˆåŠŸç‡
   - å…³æ³¨ä»»åŠ¡æ‰§è¡Œæ—¶é—´

2. **æ•°æ®åº“ç»´æŠ¤**
   - å®šæœŸæ¸…ç†æ—§çš„ä»»åŠ¡è®°å½•
   - ç›‘æ§æ•°æ®åº“å­˜å‚¨ç©ºé—´
   - å¤‡ä»½é‡è¦çš„è‚¡ç¥¨æ•°æ®

3. **æ€§èƒ½ä¼˜åŒ–**
   - æ ¹æ®ç³»ç»Ÿè´Ÿè½½è°ƒæ•´æ‰¹å¤„ç†å¤§å°
   - åˆç†è®¾ç½®å¹¶å‘ä»»åŠ¡æ•°é‡
   - ç›‘æ§å†…å­˜å’ŒCPUä½¿ç”¨æƒ…å†µ

## ğŸ“‹ API æ–‡æ¡£

å®Œæ•´çš„ API æ–‡æ¡£å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®ï¼š

- Swagger UI: http://localhost:8020/docs
- ReDoc: http://localhost:8020/redoc

## ğŸ‰ æ€»ç»“

é€šè¿‡ä»¥ä¸Šé…ç½®ï¼ŒStock Agent ç°åœ¨å…·å¤‡äº†å®Œæ•´çš„è‚¡ç¥¨æ•°æ®åˆ·æ–°è§¦å‘å™¨åŠŸèƒ½ï¼š

âœ… **è‡ªåŠ¨å®šæ—¶åˆ·æ–°**: æ¯å·¥ä½œæ—¥ä¸‹åˆ3ç‚¹è‡ªåŠ¨åˆ·æ–°æ‰€æœ‰è‚¡ç¥¨æ•°æ®  
âœ… **æŒ‰éœ€åˆ·æ–°**: æ”¯æŒå•åªè‚¡ç¥¨çš„å³æ—¶æ•°æ®åˆ·æ–°  
âœ… **ä»»åŠ¡è·Ÿè¸ª**: å®Œæ•´çš„ä»»åŠ¡çŠ¶æ€ç›‘æ§å’Œå†å²è®°å½•  
âœ… **çµæ´»é…ç½®**: æ”¯æŒè‡ªå®šä¹‰åˆ·æ–°æ—¶é—´å’Œå·¥ä½œæ—¥  
âœ… **RESTful API**: æ ‡å‡†åŒ–çš„HTTPæ¥å£ï¼Œæ˜“äºé›†æˆ  

è¿™å¥—è§¦å‘å™¨ç³»ç»Ÿå¯ä»¥ç¡®ä¿è‚¡ç¥¨æ•°æ®çš„åŠæ—¶æ€§å’Œå‡†ç¡®æ€§ï¼Œä¸ºRAG+Agentç³»ç»Ÿæä¾›å¯é çš„æ•°æ®æ”¯æ’‘ã€‚
